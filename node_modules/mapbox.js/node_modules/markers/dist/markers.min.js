typeof mapbox=="undefined"&&(mapbox={}),typeof mapbox.markers=="undefined"&&(mapbox.markers={}),mapbox.markers.layer=function(){function o(b){b.coord||(b.coord=a.map.locationCoordinate(b.location));var c=a.map.coordinatePoint(b.coord),d,e;c.x<0?(d=new MM.Location(b.location.lat,b.location.lon),d.lon+=Math.ceil((i.lon-b.location.lon)/360)*360,e=a.map.locationPoint(d),e.x<a.map.dimensions.x&&(c=e,b.coord=a.map.locationCoordinate(d))):c.x>a.map.dimensions.x&&(d=new MM.Location(b.location.lat,b.location.lon),d.lon-=Math.ceil((b.location.lon-j.lon)/360)*360,e=a.map.locationPoint(d),e.x>0&&(c=e,b.coord=a.map.locationCoordinate(d))),c.scale=1,c.width=c.height=0,MM.moveElement(b.element,c)}var a={},b=[],c=[],d=new MM.CallbackManager(a,["drawn","markeradded"]),e=null,f=mapbox.markers.simplestyle_factory,g=function(a,b){return b.geometry.coordinates[1]-a.geometry.coordinates[1]},h,i=null,j=null,k=function(){return!0},l=0,m=function(){return++l},n={};return a.parent=document.createElement("div"),a.parent.style.cssText="position: absolute; top: 0px;left:0px; width:100%; height:100%; margin:0; padding:0; z-index:0;pointer-events:none;",a.name="markers",a.addCallback=function(b,c){return d.addCallback(b,c),a},a.removeCallback=function(b,c){return d.removeCallback(b,c),a},a.draw=function(){if(!a.map)return;i=a.map.pointLocation(new MM.Point(0,0)),j=a.map.pointLocation(new MM.Point(a.map.dimensions.x,0)),d.dispatchCallback("drawn",a);for(var b=0;b<c.length;b++)o(c[b])},a.add=function(b){return!b||!b.element?null:(a.parent.appendChild(b.element),c.push(b),d.dispatchCallback("markeradded",b),b)},a.remove=function(b){if(!b)return null;a.parent.removeChild(b.element);for(var d=0;d<c.length;d++)if(c[d]===b)return c.splice(d,1),b;return b},a.markers=function(a){if(!arguments.length)return c},a.add_feature=function(b){return a.features(a.features().concat([b]))},a.sort=function(b){return arguments.length?(g=b,a):g},a.features=function(d){if(!arguments.length)return b;d||(d=[]),b=d.slice(),b.sort(g);for(var e=0;e<c.length;e++)c[e].touch=!1;for(var h=0;h<b.length;h++)if(k(b[h])){var i=m(b[h]);n[i]?(n[i].location=new MM.Location(b[h].geometry.coordinates[1],b[h].geometry.coordinates[0]),n[i].coord=null,o(n[i])):n[i]=a.add({element:f(b[h]),location:new MM.Location(b[h].geometry.coordinates[1],b[h].geometry.coordinates[0]),data:b[h]}),n[i]&&(n[i].touch=!0)}for(var j=c.length-1;j>=0;j--)c[j].touch===!1&&a.remove(c[j]);return a.map&&a.map.coordinate&&a.map.draw(),a},a.url=function(b,c){function d(b,d){if(b&&c)return c(b);var e=typeof d!="undefined"&&d.features?d.features:null;e&&a.features(e),c&&c(b,e,a)}if(!arguments.length)return h;if(typeof reqwest=="undefined")throw"reqwest is required for url loading";return typeof b=="string"&&(b=[b]),h=b,reqwest(h[0].match(/geojsonp$/)?{url:h[0]+(~h[0].indexOf("?")?"&":"?")+"callback=?",type:"jsonp",success:function(a){d(null,a)},error:d}:{url:h[0],type:"json",success:function(a){d(null,a)},error:d}),a},a.id=function(b,c){return a.url("http://a.tiles.mapbox.com/v3/"+b+"/markers.geojsonp",c)},a.csv=function(b){return a.features(mapbox.markers.csv_to_geojson(b))},a.extent=function(){var b=[{lat:Infinity,lon:Infinity},{lat:-Infinity,lon:-Infinity}],c=a.features();for(var d=0;d<c.length;d++){var e=c[d].geometry.coordinates;e[0]<b[0].lon&&(b[0].lon=e[0]),e[1]<b[0].lat&&(b[0].lat=e[1]),e[0]>b[1].lon&&(b[1].lon=e[0]),e[1]>b[1].lat&&(b[1].lat=e[1])}return b},a.key=function(b){return arguments.length?(b===null?m=function(){return++l}:m=b,a):m},a.factory=function(b){return arguments.length?(f=b,a.features(a.features()),a):f},a.filter=function(b){return arguments.length?(k=b,a.features(a.features()),a):k},a.destroy=function(){a.parent.parentNode&&a.parent.parentNode.removeChild(a.parent)},a.named=function(b){return arguments.length?(a.name=b,a):a.name},a.enabled=!0,a.enable=function(){return this.enabled=!0,this.parent.style.display="",a},a.disable=function(){return this.enabled=!1,this.parent.style.display="none",a},a},mmg=mapbox.markers.layer,mapbox.markers.interaction=function(a){function j(){a.map.addCallback("panned",function(){if(e)while(c.length)a.remove(c.pop())})}if(a&&a.interaction)return a.interaction;var b={},c=[],d=!0,e=!0,f=!0,g=null,h=!0,i;b.formatter=function(a){return arguments.length?(i=a,b):i},b.formatter(function(a){var b="",c=a.properties;return c?(c.title&&(b+='<div class="marker-title">'+c.title+"</div>"),c.description&&(b+='<div class="marker-description">'+c.description+"</div>"),typeof html_sanitize!==undefined&&(b=html_sanitize(b,function(a){if(/^(https?:\/\/|data:image)/.test(a))return a},function(a){return a})),b):null}),b.hideOnMove=function(a){return arguments.length?(e=a,b):e},b.exclusive=function(a){return arguments.length?(d=a,b):d},b.showOnHover=function(a){return arguments.length?(f=a,b):f},b.hideTooltips=function(){while(c.length)a.remove(c.pop());for(var b=0;b<k.length;b++)delete k[b].clicked},b.add=function(){return h=!0,b},b.remove=function(){return h=!1,b},b.bindMarker=function(e){var j=function(){if(f===!1)return;e.clicked||(g=window.setTimeout(function(){b.hideTooltips()},200))},k=function(k){function p(a){return a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation(),!1}if(k&&k.type=="mouseover"&&f===!1)return;if(!h)return;var l=i(e.data);if(!l)return;d&&c.length>0&&(b.hideTooltips(),g&&window.clearTimeout(g));var m=document.createElement("div");m.className="marker-tooltip",m.style.width="100%";var n=m.appendChild(document.createElement("div"));n.style.cssText="position: absolute; pointer-events: none;";var o=n.appendChild(document.createElement("div"));o.className="marker-popup",o.style.cssText="pointer-events: auto;",typeof l=="string"?o.innerHTML=l:o.appendChild(l),n.style.bottom=e.element.offsetHeight/2+20+"px",MM.addEvent(o,"mousedown",p),MM.addEvent(o,"touchstart",p),f&&(m.onmouseover=function(){g&&window.clearTimeout(g)},m.onmouseout=j);var q={element:m,data:{},interactive:!1,location:e.location.copy()};c.push(q),e.tooltip=q,a.add(q),a.draw()};e.showTooltip=k,e.element.onclick=e.element.ontouchstart=function(){k(),e.clicked=!0},e.element.onmouseover=k,e.element.onmouseout=j};if(a){a.addCallback("drawn",j);var k=a.markers();for(var l=0;l<k.length;l++)b.bindMarker(k[l]);a.addCallback("markeradded",function(a,c){c.interactive!==!1&&b.bindMarker(c)}),a.interaction=b}return b},mmg_interaction=mapbox.markers.interaction,mapbox.markers.csv_to_geojson=function(a){function b(a){var b;return c(a,function(a,c){if(c){var d={},e=-1,f=b.length;while(++e<f)d[b[e]]=a[e];return d}return b=a,null})}function c(a,b){function j(){if(f.lastIndex>=a.length)return d;if(i)return i=!1,c;var b=f.lastIndex;if(a.charCodeAt(b)===34){var e=b;while(e++<a.length)if(a.charCodeAt(e)===34){if(a.charCodeAt(e+1)!==34)break;e++}f.lastIndex=e+2;var g=a.charCodeAt(e+1);return g===13?(i=!0,a.charCodeAt(e+2)===10&&f.lastIndex++):g===10&&(i=!0),a.substring(b+1,e).replace(/""/g,'"')}var h=f.exec(a);return h?(i=h[0].charCodeAt(0)!==44,a.substring(b,h.index)):(f.lastIndex=a.length,a.substring(b))}var c={},d={},e=[],f=/\r\n|[,\r\n]/g,g=0,h,i;f.lastIndex=0;while((h=j())!==d){var k=[];while(h!==c&&h!==d)k.push(h),h=j();if(b&&!(k=b(k,g++)))continue;e.push(k)}return e}var d=[],e=b(a);if(!e.length)return d;var f="",g="";for(var h in e[0])h.match(/^Lat/i)&&(f=h),h.match(/^Lon/i)&&(g=h);if(!f||!g)throw"CSV: Could not find latitude or longitude field";for(var i=0;i<e.length;i++)e[i][g]!==undefined&&e[i][g]!==undefined&&d.push({type:"Feature",properties:e[i],geometry:{type:"Point",coordinates:[parseFloat(e[i][g]),parseFloat(e[i][f])]}});return d},mapbox.markers.simplestyle_factory=function(a){var b={small:[20,50],medium:[30,70],large:[35,90]},c=a.properties||{},d=c["marker-size"]||"medium",e=c["marker-symbol"]?"-"+c["marker-symbol"]:"",f=c["marker-color"]||"7e7e7e";f=f.replace("#","");var g=document.createElement("img");g.width=b[d][0],g.height=b[d][1],g.className="simplestyle-marker",g.alt=c.title||"",g.src=(mapbox.markers.marker_baseurl||"http://a.tiles.mapbox.com/v3/marker/")+"pin-"+d.charAt(0)+e+"+"+f+(window.devicePixelRatio===2?"@2x":"")+".png";var h=g.style;return h.position="absolute",h.clip="rect(auto auto "+b[d][1]*.75+"px auto)",h.marginTop=-(b[d][1]/2)+"px",h.marginLeft=-(b[d][0]/2)+"px",h.cursor="pointer",h.pointerEvents="all",g}